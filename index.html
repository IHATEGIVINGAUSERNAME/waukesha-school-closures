<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Waukesha School Closures - Interactive Map with Census Data</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" 
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" 
          crossorigin=""/>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
        }
        
        #map {
            height: 100vh;
            width: 100%;
        }
        
        .info-panel {
            position: absolute;
            top: 10px;
            right: 10px;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            z-index: 1000;
            max-width: 350px;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .info-panel h2 {
            margin: 0 0 10px 0;
            font-size: 18px;
            color: #333;
        }
        
        .info-panel p {
            margin: 5px 0;
            font-size: 13px;
            line-height: 1.5;
        }
        
        .stat-box {
            background: #f5f5f5;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
        
        .stat-box strong {
            color: #d32f2f;
        }
        
        .legend {
            position: absolute;
            bottom: 30px;
            right: 10px;
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            z-index: 1000;
            max-height: 60vh;
            overflow-y: auto;
        }
        
        .legend h3 {
            margin: 0 0 10px 0;
            font-size: 14px;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            margin: 5px 0;
            font-size: 12px;
        }
        
        .legend-color {
            width: 20px;
            height: 20px;
            margin-right: 8px;
            border-radius: 3px;
            border: 2px solid #333;
        }
        
        .closing { background: #d32f2f; }
        .staying { background: #2e7d32; }
        .impact-high { background: rgba(211, 47, 47, 0.3); }
        
        .school-popup h3 {
            margin: 0 0 10px 0;
            color: #333;
        }
        
        .school-popup .status {
            font-weight: bold;
            padding: 5px 10px;
            border-radius: 3px;
            display: inline-block;
            margin: 5px 0;
        }
        
        .school-popup .status.closing {
            background: #d32f2f;
            color: white;
        }
        
        .school-popup .status.staying {
            background: #2e7d32;
            color: white;
        }
        
        .school-popup .stats {
            margin: 10px 0;
            font-size: 13px;
        }
        
        .school-popup .stats div {
            margin: 5px 0;
        }
        
        #loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
            z-index: 2000;
            text-align: center;
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #2e7d32;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .census-gradient {
            background: linear-gradient(to right, #ffffcc, #ffeda0, #fed976, #feb24c, #fd8d3c, #fc4e2a, #e31a1c, #bd0026, #800026);
            height: 15px;
            width: 100%;
            border-radius: 3px;
        }

        .gradient-labels {
            display: flex;
            justify-content: space-between;
            font-size: 10px;
            margin-top: 2px;
        }
    </style>
</head>
<body>
    <div id="loading">
        <div class="spinner"></div>
        <div id="loadingText">Loading schools and census data...</div>
    </div>
    
    <div id="map"></div>
    
    <div class="info-panel">
        <h2>üö® Waukesha School Closure Pattern</h2>
        
        <div style="margin-bottom: 15px;">
            <input type="text" id="addressSearch" placeholder="Search address (e.g., 123 Main St, Waukesha, WI)" 
                   style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; font-size: 13px;">
            <button onclick="searchAddress()" 
                    style="width: 100%; margin-top: 5px; padding: 8px; background: #2e7d32; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 13px;">
                Find My Address
            </button>
            <div id="searchResult" style="margin-top: 5px; font-size: 12px; color: #666;"></div>
        </div>
        
        <div class="stat-box">
            <p><strong>2 Schools CLOSING</strong></p>
            <p><strong>12 Schools STAYING OPEN</strong></p>
            <p style="margin-top: 10px; color: #d32f2f;">Bethesda: 415 students ‚Üí CLOSING</p>
            <p style="color: #2e7d32;">Rose Glen: 495 students ‚Üí STAYING OPEN</p>
            <p style="margin-top: 5px; font-size: 11px;">80 MORE students at Rose Glen!</p>
        </div>
        
        <p><strong>Hispanic Students Affected:</strong> 334 (29.7% of district total)</p>
        <p><strong>Property Value Loss:</strong> $58-73M in closure zones</p>
        <p><strong>Board Vote:</strong> 8-1 (partisan split)</p>
        
        <div style="margin-top: 15px; padding: 10px; background: #e3f2fd; border-radius: 5px;">
            <p style="margin: 5px 0; font-weight: bold; font-size: 12px;">üìä Census Data Layer</p>
            <p style="margin: 5px 0; font-size: 11px;">Shows elementary-age children (5-11 years) by neighborhood</p>
            <p style="margin: 5px 0; font-size: 11px; color: #666;">Darker red = More children in that area</p>
        </div>
        
        <p style="font-size: 11px; margin-top: 15px; color: #666;">
            Map geocoded from school addresses<br>
            Census: American Community Survey 2022<br>
            Red zones = Impact areas<br>
            Green zones = Protected areas
        </p>
    </div>
    
    <div class="legend">
        <h3>Legend</h3>
        
        <div style="margin-bottom: 15px;">
            <div style="font-size: 12px; font-weight: bold; margin-bottom: 5px;">Elementary Age Population (5-11)</div>
            <div class="census-gradient"></div>
            <div class="gradient-labels">
                <span>Low</span>
                <span>High</span>
            </div>
        </div>
        
        <div class="legend-item">
            <div class="legend-color closing"></div>
            <span>Schools CLOSING (3)</span>
        </div>
        <div class="legend-item">
            <div class="legend-color staying"></div>
            <span>Schools STAYING OPEN (11)</span>
        </div>
        <div class="legend-item">
            <div class="legend-color impact-high"></div>Bethesda Elementary
            <span>Impact Zone (property decline)</span>
        </div>
        <div class="legend-item">
            <div style="width: 20px; height: 20px; margin-right: 8px; border-radius: 3px; border: 2px dashed #2e7d32; background: rgba(46, 125, 50, 0.15);"></div>
            <span>Protected Zone</span>
        </div>
        <div class="legend-item">
            <div style="width: 20px; height: 28px; margin-right: 8px; background: #ff6b35; border-radius: 50% 50% 50% 0; border: 2px solid white; transform: rotate(-45deg);"></div>
            <span>School Board Members</span>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
    <script src="https://unpkg.com/leaflet.heat@0.2.0/dist/leaflet-heat.js"></script>
    <script>
        let map;
        let searchMarker = null;
        let geocodedSchools = { closing: [], staying: [] };
        let censusLayer = null;
        
        // For production, move to a backend environment variable
        // Regenerate key at: https://api.census.gov/data/key_signup.html
        const CENSUS_API_KEY = 'ae6b9c44c43bfc73a2cd966a003aef032af8eef0';
        const WAUKESHA_COUNTY_FIPS = '55133'; // Wisconsin (55), Waukesha County (133)
        
        // School addresses
        const schoolAddresses = {
            closing: [
                {
                    name: "Bethesda Elementary",
                    address: "730 S University Drive, Waukesha, WI 53188",
                    enrollment: 415,
                    rank: 5,
                    hispanic: 37.9,
                    hispanicCount: 152,
                    impact: "8-10% property value decline",
                    impactAmount: "$30,000-$37,000 per home"
                },
                {
                    name: "Hawthorne Elementary",
                    address: "1111 Maitland Drive, Waukesha, WI 53188",
                    enrollment: 325,
                    hispanic: 56.7,
                    hispanicCount: 182,
                    impact: "8-10% property value decline",
                    impactAmount: "$30,000-$37,000 per home"
                },

                {
                    name: "Whittier Elementary",
                    address: "1103 S East Ave, Waukesha, WI 53188",
                    enrollment: 142,
                    hispanic: 34.5,
                    impact: "8-10% property value decline", 
                    impactAmount: "$30,000-$37,000 per home"
                } 
            ],
            staying: [
                {
                    name: "Banting Elementary",
                    address: "2019 Butler Drive, Waukesha, WI 53186"
                },
                {
                    name: "Blair Elementary",
                    address: "301 Hyde Park Avenue, Waukesha, WI 53188"
                },
                {
                    name: "Hadfield Elementary",
                    address: "733 Linden Street, Waukesha, WI 53186",
                    enrollment: 331
                },
                {
                    name: "Heyer Elementary",
                    address: "1209 Heyer Drive, Waukesha, WI 53186",
                    enrollment: 345
                },
                {
                    name: "Hillcrest Elementary",
                    address: "2200 Davidson Road, Waukesha, WI 53186",
                    enrollment: 239,
                    rank: 13,
                    note: "SMALLEST SCHOOL - 176 FEWER students than Bethesda"
                },
                {
                    name: "Lowell Elementary",
                    address: "140 N Grandview Blvd, Waukesha, WI 53188",
                    enrollment: 373,
                    hispanic: 20.3
                },
                {
                    name: "Meadowbrook Elementary",
                    address: "3130 Rolling Ridge Drive, Waukesha, WI 53188"
                },
                {
                    name: "Prairie Elementary",
                    address: "1801 Center Road, Waukesha, WI 53189"
                },
                {
                    name: "Rose Glen Elementary",
                    address: "W273S3845 Brookhill Drive, Waukesha, WI 53189",
                    enrollment: 495,
                    hispanic: 4.7,
                    note: "495 STUDENTS - 80 MORE than Bethesda! Only 4.7% Hispanic"
                },
                {
                    name: "Saratoga Elementary",
                    address: "130 Walton Avenue, Waukesha, WI 53186"
                },
                {
                    name: "Summit View Elementary",
                    address: "2100 Summit Avenue, Waukesha, WI 53188"
                },
                {
                    name: "White Rock Elementary",
                    address: "1150 Whiterock Avenue, Waukesha, WI 53186"
                }
            ]
        };

        // School Board Members
        const schoolBoardMembers = [
            {
                name: "Kelly Piacsek",
                title: "School Board Member ‚Äì President",
                address: "N22 W26515 Shooting Star Rd., Pewaukee, WI 53072",
                email: "klpiacsek@waukesha.k12.wi.us"
            },
            {
                name: "Anthony Zenobia",
                title: "School Board Member ‚Äì Vice President",
                address: "S57 W29587 Saylesville Rd., Waukesha, WI 53189",
                email: "azenobia@waukesha.k12.wi.us"
            },
            {
                name: "David Wadd",
                title: "School Board Member ‚Äì Clerk",
                address: "W278 N1577 Lakeview Drive, Pewaukee, WI 53072",
                email: "dwadd@waukesha.k12.wi.us"
            },
            {
                name: "Karrie Kozlowski",
                title: "School Board Member ‚Äì Treasurer",
                address: "S52 W25449 Poppy Fields Rd., Waukesha, WI 53189",
                email: "kkozlowski@waukesha.k12.wi.us"
            },
            {
                name: "Eric Brooks",
                title: "School Board Member",
                address: "1606 Swartz Drive, Waukesha, WI 53188",
                email: "ebrooks@waukesha.k12.wi.us"
            },
            {
                name: "Natalie Grehn",
                title: "School Board Member",
                address: "1737 Blackhawk Trail, Waukesha, WI 53186",
                email: "ngrehn@waukesha.k12.wi.us"
            },
            {
                name: "Diane Voit",
                title: "School Board Member",
                address: "W261 S3142 View Drive, Waukesha, WI 53189",
                email: "dvoit@waukesha.k12.wi.us"
            },
            {
                name: "Bette Koenig",
                title: "School Board Member",
                address: "S32 W27655 Dale View Drive, Waukesha, WI 53189",
                email: "ekoenig@waukesha.k12.wi.us"
            },
            {
                name: "Thomas Harland",
                title: "School Board Member",
                address: "1115 River Place Blvd., Waukesha, WI 53189",
                email: "tharland@waukesha.k12.wi.us"
            }
        ];
        
        let geocodedBoardMembers = [];
        
        // Geocoding cache to avoid duplicate requests
        const geocodeCache = {};
        
        // Geocode a single address with caching
        async function geocodeAddress(address) {
            // Check cache first
            if (geocodeCache[address]) {
                return geocodeCache[address];
            }
            
            try {
                const response = await fetch(
                    `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}&limit=1`
                );
                const data = await response.json();
                if (data.length > 0) {
                    const result = {
                        lat: parseFloat(data[0].lat),
                        lng: parseFloat(data[0].lon)
                    };
                    // Cache the result
                    geocodeCache[address] = result;
                    return result;
                }
            } catch (error) {
                console.error(`Geocoding error for "${address}":`, error);
            }
            return null;
        }
        
        // Batch geocode multiple addresses with rate limiting
        async function batchGeocodeAddresses(addresses, delayMs = 1100) {
            const results = {};
            
            for (const address of addresses) {
                results[address] = await geocodeAddress(address);
                // Rate limit: respect Nominatim's 1 request/second guideline
                await new Promise(resolve => setTimeout(resolve, delayMs));
            }
            
            return results;
        }
        
        // Fetch census tract boundaries and population data
        async function loadCensusData() {
            updateLoadingText('Loading census tract boundaries...');
            
            try {
                // Get census tract boundaries from Census Bureau TIGERweb
                const tractResponse = await fetch(
                    `https://tigerweb.geo.census.gov/arcgis/rest/services/TIGERweb/tigerWMS_Census2020/MapServer/8/query?where=COUNTY='133'+AND+STATE='55'&outFields=*&outSR=4326&f=geojson`
                );
                const tractData = await tractResponse.json();
                
                // Tighter bounds based on school locations - Waukesha city proper
                const schoolDistrictBounds = {
                    minLat: 42.96,
                    maxLat: 43.08,
                    minLng: -88.32,
                    maxLng: -88.18
                };
                
                tractData.features = tractData.features.filter(feature => {
                    if (!feature.geometry || !feature.geometry.coordinates) return false;
                    
                    // Get centroid of tract
                    const rings = feature.geometry.coordinates[0];
                    let sumLat = 0, sumLng = 0, count = 0;
                    
                    rings.forEach(coord => {
                        sumLng += coord[0];
                        sumLat += coord[1];
                        count++;
                    });
                    
                    const centroidLng = sumLng / count;
                    const centroidLat = sumLat / count;
                    
                    // Keep only tracts within tighter school district bounds
                    return centroidLat >= schoolDistrictBounds.minLat && 
                           centroidLat <= schoolDistrictBounds.maxLat &&
                           centroidLng >= schoolDistrictBounds.minLng && 
                           centroidLng <= schoolDistrictBounds.maxLng;
                });
                
                updateLoadingText('Loading elementary-age population data...');
                
                console.log(`Filtered to ${tractData.features.length} census tracts in school district area`);
                
                // Get population data for ages 5-9 and 10-11
                // B01001_004E = Male 5-9, B01001_028E = Female 5-9
                // B01001_005E = Male 10-14, B01001_029E = Female 10-14
                // Using 2022 ACS5 (most recent complete dataset)
                const populationResponse = await fetch(
                    `https://api.census.gov/data/2022/acs/acs5?get=NAME,B01001_004E,B01001_028E,B01001_005E,B01001_029E&for=tract:*&in=state:55%20county:133&key=${CENSUS_API_KEY}`
                );
                
                if (!populationResponse.ok) {
                    throw new Error(`Census API error: ${populationResponse.status}. Key may be invalid or expired.`);
                }
                
                const popData = await populationResponse.json();
                
                // Check for Census API errors
                if (!Array.isArray(popData) || popData.length === 0) {
                    throw new Error('Census API returned invalid data. Verify API key is active.');
                }
                
                // Process population data with 2025 adjustment (+4% for aging and new school-age children)
                const popByTract = {};
                const growthAdjustment = 1.04; // 4% growth from 2022 to 2025 to account for aging cohorts and new entrants
                
                for (let i = 1; i < popData.length; i++) {
                    const row = popData[i];
                    const tractId = row[7]; // tract ID is at index 7 (last column)
                    const male59 = parseInt(row[1]) || 0;
                    const female59 = parseInt(row[2]) || 0;
                    const male1014 = parseInt(row[3]) || 0;
                    const female1014 = parseInt(row[4]) || 0;
                    
                    // Estimate 10-11 as roughly 2/5 of 10-14 age group
                    const elem1011 = Math.round((male1014 + female1014) * 0.4);
                    const elemTotal2022 = male59 + female59 + elem1011;
                    
                    // Adjust to 2025 estimates: +4% growth over 3 years to capture aging and new school-age children
                    const elemTotal = Math.round(elemTotal2022 * growthAdjustment);
                    
                    popByTract[tractId] = {
                        total: elemTotal,
                        ages59: Math.round((male59 + female59) * growthAdjustment),
                        ages1011: Math.round(elem1011 * growthAdjustment)
                    };
                    console.log(`Tract ${tractId}: ${elemTotal} children (2025 adjusted from ${elemTotal2022} in 2022)`);
                }
                
                console.log(`Loaded population data for ${Object.keys(popByTract).length} census tracts`);
                console.log('Sample tract data:', Object.values(popByTract).slice(0, 3));
                
                // Find min/max for color scaling
                const populations = Object.values(popByTract).map(p => p.total);
                const minPop = Math.min(...populations);
                const maxPop = Math.max(...populations);
                
                console.log(`Elementary age population range: ${minPop} - ${maxPop}`);
                console.log(`Average: ${Math.round(populations.reduce((a,b) => a+b, 0) / populations.length)}`);
                
                // Add population data to GeoJSON features
                tractData.features.forEach(feature => {
                    const tractId = feature.properties.TRACT;
                    if (popByTract[tractId]) {
                        feature.properties.elemPop = popByTract[tractId].total;
                        feature.properties.ages59 = popByTract[tractId].ages59;
                        feature.properties.ages1011 = popByTract[tractId].ages1011;
                    } else {
                        feature.properties.elemPop = 0;
                    }
                });
                
                // Color function
                function getColor(population) {
                    const ratio = (population - minPop) / (maxPop - minPop);
                    const colors = [
                        '#ffffcc', '#ffeda0', '#fed976', '#feb24c', 
                        '#fd8d3c', '#fc4e2a', '#e31a1c', '#bd0026', '#800026'
                    ];
                    const index = Math.min(Math.floor(ratio * colors.length), colors.length - 1);
                    return colors[index];
                }
                
                // Add census layer to map
                censusLayer = L.geoJSON(tractData, {
                    style: function(feature) {
                        return {
                            fillColor: getColor(feature.properties.elemPop || 0),
                            weight: 1,
                            opacity: 0.5,
                            color: '#666',
                            fillOpacity: 0.5
                        };
                    },
                    onEachFeature: function(feature, layer) {
                        const props = feature.properties;
                        const popupContent = `
                            <div style="font-size: 12px;">
                                <strong>Census Tract ${props.TRACT}</strong><br>
                                <strong>Elementary Age (5-11):</strong> ${props.elemPop || 0} children<br>
                                <span style="font-size: 11px;">
                                    Ages 5-9: ${props.ages59 || 0}<br>
                                    Ages 10-11: ${props.ages1011 || 0}
                                </span>
                            </div>
                        `;
                        layer.bindPopup(popupContent);
                    }
                }).addTo(map);
                
                return true;
            } catch (error) {
                console.error('Error loading census data:', error);
                updateLoadingText('Census data unavailable - showing schools only');
                await new Promise(resolve => setTimeout(resolve, 2000));
                return false;
            }
        }
        
        function updateLoadingText(text) {
            document.getElementById('loadingText').textContent = text;
        }
        
        // Geocode all schools
        async function geocodeAllSchools() {
            const loadingDiv = document.getElementById('loading');
            
            try {
                updateLoadingText('Geocoding schools...');
                
                // Collect all addresses to geocode
                const closingAddresses = schoolAddresses.closing.map(s => s.address);
                const stayingAddresses = schoolAddresses.staying.map(s => s.address);
                const boardAddresses = schoolBoardMembers.map(m => m.address);
                const allAddresses = [...closingAddresses, ...stayingAddresses, ...boardAddresses];
                
                // Remove duplicates
                const uniqueAddresses = [...new Set(allAddresses)];
                
                // Batch geocode all addresses with rate limiting
                const results = await batchGeocodeAddresses(uniqueAddresses);
                
                // Map results back to closing schools
                for (const school of schoolAddresses.closing) {
                    const coords = results[school.address];
                    if (coords) {
                        geocodedSchools.closing.push({ ...school, ...coords });
                    }
                }
                
                // Map results back to staying schools
                for (const school of schoolAddresses.staying) {
                    const coords = results[school.address];
                    if (coords) {
                        geocodedSchools.staying.push({ ...school, ...coords });
                    }
                }
                
                updateLoadingText('Geocoding school board members...');
                
                // Map results back to board members
                for (const member of schoolBoardMembers) {
                    const coords = results[member.address];
                    if (coords) {
                        geocodedBoardMembers.push({ ...member, ...coords });
                    }
                }
                
                // Initialize map
                initMap();
                
                // Load census data
                await loadCensusData();
                
                loadingDiv.style.display = 'none';
            } catch (error) {
                loadingDiv.innerHTML = `<div style="color: #d32f2f;">Error loading data: ${error.message}</div>`;
            }
        }
        
        function initMap() {
            map = L.map('map').setView([43.0117, -88.2315], 12);
            window.mapInstance = map;
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors',
                maxZoom: 18
            }).addTo(map);
            
            // Create custom icons
            const closingIcon = L.divIcon({
                className: 'custom-marker',
                html: '<div style="background: #d32f2f; width: 50px; height: 50px; border-radius: 50%; border: 5px solid white; box-shadow: 0 4px 12px rgba(0,0,0,0.5);"></div>',
                iconSize: [50, 50],
                iconAnchor: [25, 25]
            });
            
            const stayingIcon = L.divIcon({
                className: 'custom-marker',
                html: '<div style="background: #2e7d32; width: 20px; height: 20px; border-radius: 50%; border: 2px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.3);"></div>',
                iconSize: [20, 20],
                iconAnchor: [10, 10]
            });
            
            // Add closing schools
            geocodedSchools.closing.forEach(school => {
                const popupContent = `
                    <div class="school-popup">
                        <h3>${school.name}</h3>
                        <div class="status closing">CLOSING Fall 2026</div>
                        <div class="stats">
                            <div><strong>Enrollment:</strong> ${school.enrollment} students ${school.rank ? `(#${school.rank} of 13)` : ''}</div>
                            <div><strong>Hispanic Students:</strong> ${school.hispanicCount} (${school.hispanic}%)</div>
                            <div><strong>Address:</strong> ${school.address}</div>
                            <div style="margin-top: 10px; padding: 10px; background: #ffebee; border-radius: 3px;">
                                <div><strong>Property Impact:</strong></div>
                                <div>${school.impact}</div>
                                <div>${school.impactAmount}</div>
                            </div>
                        </div>
                    </div>
                `;
                
                L.marker([school.lat, school.lng], { icon: closingIcon })
                    .bindPopup(popupContent, { maxWidth: 300 })
                    .addTo(map);
                
                // Impact zone
                L.circle([school.lat, school.lng], {
                    radius: 2000,
                    color: '#d32f2f',
                    fillColor: '#d32f2f',
                    fillOpacity: 0.25,
                    weight: 3
                }).addTo(map);
            });
            
            // Add staying schools
            geocodedSchools.staying.forEach(school => {
                let popupContent = `
                    <div class="school-popup">
                        <h3>${school.name}</h3>
                        <div class="status staying">STAYING OPEN</div>
                        <div class="stats">
                `;
                
                if (school.enrollment) {
                    popupContent += `<div><strong>Enrollment:</strong> ${school.enrollment} students ${school.rank ? `(#${school.rank} of 13)` : ''}</div>`;
                }
                
                if (school.hispanic) {
                    popupContent += `<div><strong>Hispanic:</strong> ${school.hispanic}%</div>`;
                }
                
                popupContent += `<div><strong>Address:</strong> ${school.address}</div>`;
                
                if (school.note) {
                    popupContent += `<div style="margin-top: 10px; padding: 10px; background: #fff3cd; border-radius: 3px;">
                        <strong>‚ö†Ô∏è ${school.note}</strong>
                    </div>`;
                }
                
                popupContent += `
                            <div style="margin-top: 10px; padding: 10px; background: #e8f5e9; border-radius: 3px;">
                                <strong>Property values: PROTECTED</strong>
                            </div>
                        </div>
                    </div>
                `;
                
                L.marker([school.lat, school.lng], { icon: stayingIcon })
                    .bindPopup(popupContent, { maxWidth: 300 })
                    .addTo(map);
                
                // Protected zone
                L.circle([school.lat, school.lng], {
                    radius: 1500,
                    color: '#2e7d32',
                    fillColor: '#2e7d32',
                    fillOpacity: 0.15,
                    weight: 2,
                    dashArray: '5, 5'
                }).addTo(map);
            });
            
            // Heat map
            const heatData = geocodedSchools.closing.map(school => [school.lat, school.lng, 1.0]);
            L.heatLayer(heatData, {
                radius: 40,
                blur: 30,
                maxZoom: 17,
                max: 1.0,
                gradient: { 0.2: '#ffeda0', 0.4: '#fed976', 0.6: '#feb24c', 0.8: '#fd8d3c', 1.0: '#e31a1c' }
            }).addTo(map);

            // Add school board members
            const boardMemberIcon = L.divIcon({
                className: 'custom-marker',
                html: '<div style="background: #ff6b35; width: 30px; height: 40px; border-radius: 50% 50% 50% 0; border: 2px solid white; box-shadow: 0 3px 8px rgba(0,0,0,0.4); transform: rotate(-45deg);"></div><div style="position: absolute; top: 8px; left: 50%; transform: translate(-50%, 0); color: white; font-size: 16px; font-weight: bold;">üìå</div>',
                iconSize: [30, 40],
                iconAnchor: [15, 35]
            });

            geocodedBoardMembers.forEach(member => {
                const popupContent = `
                    <div class="school-popup" style="text-align: left;">
                        <h3 style="margin: 0 0 5px 0; font-size: 16px;">${member.name}</h3>
                        <div style="font-weight: bold; color: #ff6b35; margin-bottom: 8px; font-size: 12px;">${member.title}</div>
                        <div style="font-size: 12px; margin: 5px 0;">
                            <div><strong>üìç Address:</strong></div>
                            <div style="margin-left: 20px; word-wrap: break-word;">${member.address}</div>
                        </div>
                        <div style="font-size: 12px; margin: 8px 0;">
                            <strong>üìß Email:</strong><br/>
                            <a href="mailto:${member.email}" style="color: #ff6b35; text-decoration: none; margin-left: 20px;">${member.email}</a>
                        </div>
                    </div>
                `;

                L.marker([member.lat, member.lng], { icon: boardMemberIcon })
                    .bindPopup(popupContent, { maxWidth: 300 })
                    .addTo(map);
            });
        }
        
        // Address search function
        window.searchAddress = async function() {
            const addressInput = document.getElementById('addressSearch');
            const resultDiv = document.getElementById('searchResult');
            const address = addressInput.value.trim();
            
            if (!address) {
                resultDiv.innerHTML = '<span style="color: #d32f2f;">Please enter an address</span>';
                return;
            }
            
            resultDiv.innerHTML = 'Searching...';
            
            try {
                const coords = await geocodeAddress(address);
                
                if (!coords) {
                    resultDiv.innerHTML = '<span style="color: #d32f2f;">Address not found</span>';
                    return;
                }
                
                if (searchMarker) {
                    map.removeLayer(searchMarker);
                }
                
                const searchIcon = L.divIcon({
                    className: 'custom-marker',
                    html: '<div style="background: #ff9800; width: 25px; height: 25px; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.5);"></div>',
                    iconSize: [25, 15],
                    iconAnchor: [12.5, 12.5]
                });
                
                searchMarker = L.marker([coords.lat, coords.lng], { icon: searchIcon }).addTo(map);
                
                const allSchools = [...geocodedSchools.closing, ...geocodedSchools.staying];
                let nearestSchool = null;
                let minDistance = Infinity;
                
                allSchools.forEach(school => {
                    const distance = map.distance([coords.lat, coords.lng], [school.lat, school.lng]);
                    if (distance < minDistance) {
                        minDistance = distance;
                        nearestSchool = school;
                    }
                });
                
                const inImpactZone = geocodedSchools.closing.some(school => {
                    return map.distance([coords.lat, coords.lng], [school.lat, school.lng]) <= 2000;
                });
                
                const inProtectedZone = geocodedSchools.staying.some(school => {
                    return map.distance([coords.lat, coords.lng], [school.lat, school.lng]) <= 1500;
                });
                
                let popupHTML = '<div class="school-popup"><h3>üìç Your Address</h3>';
                
                if (inImpactZone) {
                    popupHTML += `<div style="padding: 10px; background: #ffebee; border-radius: 3px; margin: 10px 0;">
                        <strong style="color: #d32f2f;"> HIGH IMPACT ZONE</strong>
                        <div style="margin-top: 5px; font-size: 12px;">Expected decline: 8-10% ($30K-$37K)</div>
                    </div>`;
                    resultDiv.innerHTML = '<span style="color: #d32f2f;"> HIGH IMPACT ZONE</span>';
                } else if (inProtectedZone) {
                    popupHTML += `<div style="padding: 10px; background: #e8f5e9; border-radius: 3px; margin: 10px 0;">
                        <strong style="color: #2e7d32;">‚úì PROTECTED ZONE</strong>
                        <div style="margin-top: 5px; font-size: 12px;">Property values safe</div>
                    </div>`;
                    resultDiv.innerHTML = '<span style="color: #2e7d32;">‚úì PROTECTED ZONE</span>';
                } else {
                    popupHTML += `<div style="padding: 10px; background: #fff3cd; border-radius: 3px; margin: 10px 0;">
                        <strong>Outside primary zones</strong>
                    </div>`;
                    resultDiv.innerHTML = 'Outside primary zones';
                }
                
                if (nearestSchool) {
                    const distanceKm = (minDistance / 1000).toFixed(2);
                    const status = geocodedSchools.closing.includes(nearestSchool) ? 'CLOSING' : 'STAYING OPEN';
                    const statusColor = geocodedSchools.closing.includes(nearestSchool) ? '#d32f2f' : '#2e7d32';
                    
                    popupHTML += `<div style="margin-top: 10px; font-size: 12px;">
                        <strong>Nearest:</strong> ${nearestSchool.name} (${distanceKm} km)<br>
                        <strong>Status:</strong> <span style="color: ${statusColor};">${status}</span>
                    </div>`;
                }
                
                popupHTML += '</div>';
                searchMarker.bindPopup(popupHTML, { maxWidth: 300 }).openPopup();
                map.setView([coords.lat, coords.lng], 15);
                
            } catch (error) {
                resultDiv.innerHTML = '<span style="color: #d32f2f;">Error searching</span>';
            }
        };
        
        document.getElementById('addressSearch').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') searchAddress();
        });
        
        // Start loading
        geocodeAllSchools();
    </script>
</body>
</html>
